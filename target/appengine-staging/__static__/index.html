<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="google-signin-scope" content="profile email">
    <meta name="google-signin-client_id"
        content="381930324621-0odprcg2kfa6bn0tmgs9v095nvjvr2ul.apps.googleusercontent.com">    
<title>Petitons</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@4.5.2/dist/cyborg/bootstrap.min.css"/>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://unpkg.com/jwt-decode/build/jwt-decode.js"></script>
<script src="https://unpkg.com/mithril/mithril.js"></script>

</head>
<body>

    <script>
        var global = {
            login: false,
            baseApi: "",
            signe: false,
            ajout: false,
            myPetition: false,
            active: "home",
            finList: false
        }
        var User = {
            name: "",
            email: "",
            ID: ""
        }
        var Petition = {
          petitions: [{description: "", theme: "", titre: "", nomProprietaire: "", nombreSignature: 0, created_at: "" }],
          petitionsTop: [],
          nextPage : "0",
          previous : ["0"],
          pageActuel: 1,
          petition: {titre: "",
                  description: "",
                  theme: "",
                  proprietaire: "",
                  nomProprietaire: "",
                  nombreSignature: "",
                  proprietaire: "",
                  created_at: ""
                },
          petitionID: "",
          list: ["barry", "diallo"],
          titre: "",
          Description: "",
          theme: "",
          nbSignataire: 40000,
          save: function () {
              const petition = {
                  titre: this.titre,
                  description: this.Description,
                  theme: this.theme,
                  proprietaire: User.email,
                  nomProprietaire: User.name,
                  nombreSignature: this.nbSignataire
              }
              return m.request({
	            method: "POST",
	            url: "_ah/api/myApi/v1/savePetition?credential=" + encodeURIComponent(User.ID),
	            body: petition,
	        })
	        .then(function(result) {
	        	Petition.getPetition(result.key.name).then(function (e) {
                    m.route.set("/petition/"+ result.key.name)
                })
	        })
          },
          getPetitions: function (next) {
            return m.request({
	            method: "GET",
	            url: "_ah/api/myApi/v1/petitions?nextPage="+next,
	        })
	        .then(function(result) {  
               console.log(result)
              if(result.items === undefined)  {
                 global.finList = true
                 
              }else {
                  global.finList = false
                   Petition.petitions = result.items
                    Petition.nextPage = result.nextPageToken 
                     if(!Petition.previous.includes(next)) {
                        Petition.previous.push(next) 
                }
             
              }
	                  
	        })
          },
          getTop100: function () {
            return m.request({
	            method: "GET",
	            url: "_ah/api/myApi/v1/top100"
	        })
	        .then(function(result) {  
              
	          Petition.petitionsTop= result.items 
              console.log(Petition.petitionsTop)        
	        })
          },
          getMesPetitions: function (next, userID) {
            return m.request({
	            method: "GET",
	            url: "_ah/api/myApi/v1/petitions/:userID/mesPetitions?nextPage="+next,
                params: {userID: userID}
	        })
	        .then(function(result) {  
               console.log(result) 
                Petition.petitions = result.items
                 Petition.nextPage = result.nextPageToken 
               if(!Petition.previous.includes(next)) {
                  Petition.previous.push(next) 
               }
              })
          },
          getPetition: function (petitionID) {
              console.log("rentre")
              console.log("petion Id" +petitionID)
            return m.request({
	            method: "GET",
	            url: "_ah/api/myApi/v1/petitions/:petitionID",
                params: {petitionID: petitionID}
	        })
	        .then(function(result) {  
               Petition.petition = result.properties
               Petition.petitionID = result.key.name
               console.log(Petition.petition)
	        }) 
          },
          addSignature: function(petitionID) {
              console.log(User.email)
            return m.request({
	            method: "GET",
	            url: "_ah/api/myApi/v1/signature/petition/:petitionID/:userID",
                params: {petitionID: petitionID, userID: User.email}
	        })
	        .then(function(result) {  
               //Petition.petition = result
               console.log(result)
               if(result.properties.status == "nok") {
                   global.signe = true
               }else {
                   global.ajout = true
               }
	        }) 
          }
        }
        var connexionBtn = {
        oncreate: function() {
            console.log("create")
        }, 
        view: function() {
            return m('div', {class:'container'}, [
            m("p", {class: 'title text text-success'}, 'Connectez vous pour acceder à tous les services proposés'),
            m("div", {
                id:"g_id_onload",
                "data-client_id":"381930324621-0odprcg2kfa6bn0tmgs9v095nvjvr2ul.apps.googleusercontent.com",
                "data-auto_prompt":"true",
                "data-callback": "onSignIn"
            }),
            m("div", {
                class: "g_id_signin", "data-type" :"standard",
                "data-size": "large",
                "data-theme": "outline",
                "data-text": "sign_in_with",
                "data-shape": "rectangular",
                "data-logo_alignment": "left",
            })
            ])
         }
        }
        function onSignIn(googleUser) {
           const profile = jwt_decode(googleUser.credential);
           User.email = profile.email
           global.login = true
           User.name = profile.name
            console.log(User.ID)
            console.log(User)
            m.route.set("/petitions")
            
        }
        var createPetitionForm = {
        oninit : notSubmit = false  ,
        view: function() {
            return m("div",{style: "margin-top: 50px"}, [
            m("h5", {class: "text text-center"}, "Creation d'une petition"), 
            m("p", {class: "text text-danger", style: notSubmit ? "" : "display: none"}, "Remplir tous les champs obligatoires (*)"),
            m("form",{
                onsubmit: function(e) {
                e.preventDefault()
                 if(Petition.titre == "" || Petition.description == "" || Petition.theme =="") {
                     notSubmit = true
                 }else {
                     console.log("valide")
                     notSubmit = false
                   Petition.save()
                 }  
		      }
            }, [
            m("div", {class: "row"}, [
                m("div", {class: "col-6"}, [
                      m("label.label",{class: "col-form-label"},"* Titre de la petition"),
                      m("input.input[placeholder=Titre]", {class: "form-control",
                      oninput: function (e) {
                       Petition.titre = e.target.value
                    }
                 }),
                ]),
                m("div", {class: "col-6"}, [
                     m("label.label", {class: "col-form-label"},"* Thème"),
                     m("input.input[placeholder=Thème]", {class: "form-control",
                     oninput: function (e) {
                         Petition.theme = e.target.value
                     }
                    }), 
                ]),
            ]),  
             m("div", {class: "row"}, [
                m("div", {class: "col-6"}, [
                      m("label.label",{class: "col-form-label"},"Objectif à atteindre (Nombre)"),
                      m("input.input[placeholder=Nombre][type=number]",{ class: "form-control",
                      oninput: function (e) {
                       Petition.nbSignataire = e.target.value
                    }
                 }),
                ]),
                m("div", {class: "col-6"}, [
                     m("label.label", {class: "col-form-label"},"Image"),
                     m("input.input[placeholder=Image][type = file]", {class: "form-control",
                     oninput: function (e) {
                         Petition.theme = e.target.value
                     }
                    }), 
                ]),
            ]),   
            m("label.label",{class: "col-form-label"}, "* Description"),
            m("textarea[placeholder=Description de la petition]", {class: "form-control",
            oninput: function (e) {
                Petition.Description = e.target.value
            },
             rows: "5"
            }),
            m("button.button[type=submit]",{class: "btn btn-success", style: "margin-top: 10px"}, "Lancer"),
        ])
            ])
           
            }
        }
        var navBar = {
            view: function() {
                 return m("script", {"src":"https://apis.google.com/js/platform.js","async":"async","defer":"defer"}),
                 m('nav', {class: "navbar navbar-expand-lg navbar-dark bg-dark"}, [
                       m('div', {class: "container-fluid"}, [
                       m('div', {class: "collapse navbar-collapse", id: "navbarColor03"}, [
                           m('ul', {class: "navbar-nav me-auto"}, [
                               m('li', {class: global.active == "home" ? "active nav-item" : "nav-item"}, [
                                   m(m.route.Link, {href: "/petitions", class: "nav-link", onclick: function(e) {
                                       Petition.nextPage = "0"
                                   }}, "Petition")
                               ]),
                               m('li', {class: global.active == "createPetition" ? "active nav-item": "nav-item"}, [
                                  m(m.route.Link, {href: "/create_petition", class: "nav-link"}, "Lancer une petition")
                               ]),
                               m('li', {class: global.active == "mesPetition" ? "active nav-item": "nav-item"}, [
                                   m(m.route.Link, {href: "/mesPetitions", class: "nav-link"}, "Mes petitions signées")
                               ]),
                               m('li', {class: global.active == "top100" ? "active nav-item": "nav-item"}, [
                                   m(m.route.Link, {href: "/top100", class: "nav-link"}, "Les 100 les plus signées")
                               ]),
                               m('li', {class: "nav-item right"}, [
                                  m(m.route.Link, {href: "/petitions", class: "nav-link", onclick: function (e) {
                                      Petition.nextPage = "0"
                                  }}, User.name)
                               ])
                           ])
                       ])    
                       ])    
                     ])
            }
        }
           var listeDesPetitions = {
            oninit: function(e) {
                Petition.petitions = [{properties:{description: "", theme: "", titre: "", nomProprietaire: "", nombreSignature: 0, created_at: "" }, key: {name: ""}}],
                Petition.getPetitions(Petition.nextPage)
            } ,
            view: function () {
                return m("div",  Petition.petitions.map(function (item) {
                    return m("div", {class: "row", style: "margin-top: 25px"},[
                        m("div",{class: "card col-6 offset-3", style: "cursor: pointer", onclick: function(e) {
                            Petition.petitionID = item.key.name
                            Petition.getPetition(Petition.petitionID).then(function(e) {
                                m.route.set("/petition/"+ item.key.name)
                            })
                        } }, [
                                m("div", {class: "row"}, [
                                    m("div", {class: "col-3"}, [
                                        m("img", {src: "https://www.assemblee-nationale.fr/dyn/assets/images/deposer-une-petition.png", width: "170"}, "Image petition")
                                    ]),
                                    m("div", {class: "col-9"}, [
                                        m("h5", {class: "text-justify"}, item.properties.titre),
                                        m("p", {class: "text-justify"}, [
                                            item.properties.description === undefined ? "": item.properties.description.slice(0,100) + "...",
                                            m(m.route.Link, {href: "/petition/"+ item.key.name, class: "nav-link", onclick: function (e) {
                                                Petition.petitionID = item.key.name
                                                Petition.getPetition(Petition.petitionID)
                                            }}, "Plus de details")
                                        ]),
                                        m("p", {class: "text-right text-success"},item.properties.nombreSignature + "  signatures pour un objectif de 2 0000"),
                                        m("p", {class: "text-center"},"Publiée le : " + item.properties.created_at),
                                        
                                        
                                    ])
                                ])
                        ])
                ])
                }))
                
                 
            }
        }
        var top100 = {
            oninit: function(e) {
                Petition.petitionsTop = [],
                Petition.getTop100()
                global.active = "top100"
            } ,
            view: function () {
                return m("div",  Petition.petitionsTop.map(function (item) {
                    return m("div", {class: "row", style: "margin-top: 25px"},[
                        m("div",{class: "card col-6 offset-3"}, [
                                m("div", {class: "row"}, [
                                    m("div", {class: "col-3"}, [
                                        m("img", {src: "https://www.assemblee-nationale.fr/dyn/assets/images/deposer-une-petition.png", width: "170"}, "Image petition")
                                    ]),
                                    m("div", {class: "col-9"}, [
                                        m("h5", {class: "text-justify"}, item.properties.titre),
                                        m("p", {class: "text-justify"}, [
                                            item.properties.description,
                                            m(m.route.Link, {href: "/petition/"+ item.key.name, class: "nav-link", onclick: function (e) {
                                                Petition.petitionID = item.key.name
                                                Petition.getPetition(Petition.petitionID)
                                            }}, "Plus de details")
                                        ]),
                                        m("p", {class: "text-right text-success"}, item.properties.nombreSignature + " Personnes ont signé  cette petition "),
                                        m("p", {class: "text-center"},"Publiée le : " + item.properties.created_at),
                                        
                                        
                                    ])
                                ])
                        ])
                ])
                }))
                
                 
            }
        }
        var mesPetitionsSignees = {
            oninit: function(e) {
                Petition.getMesPetitions(Petition.nextPage, User.userID)
                console.log("initialisation")
                global.active = "mesPetitions"
            } ,
            view: function () {
                return m("div",  Petition.petitions.map(function (item) {
                    return m("div", {class: "row", style: "margin-top: 25px"},[
                        m("div",{class: "card col-6 offset-3"}, [
                                m("div", {class: "row"}, [
                                    m("div", {class: "col-3"}, [
                                        m("img", {src: "https://www.assemblee-nationale.fr/dyn/assets/images/deposer-une-petition.png", width: "170"}, "Image petition")
                                    ]),
                                    m("div", {class: "col-9"}, [
                                        m("h5", {class: "text-justify"}, item.properties.titre),
                                        m("p", {class: "text-justify"}, [
                                            item.properties.description,
                                            m(m.route.Link, {href: "/petition/"+ item.key.name, class: "nav-link", onclick: function (e) {
                                                Petition.petitionID = item.key.name
                                                Petition.getPetition(Petition.petitionID)
                                            }}, "Plus de details")
                                        ]),
                                        m("p", {class: "text-right text-success"},item.properties.nombreSignature - 1 +" et moi avons signé cette petition " ),
                                        m("p", {class: "text-center"},"Publiée le : " + item.properties.created_at),
                                        
                                        
                                    ])
                                ])
                        ])
                ])
                }))
                
                 
            }
        }
        var pagination = {
            oninit: function(e) {
                Petition.getPetitions(Petition.nextPage)
                
            },
            view: function () {
                return m("div",  Petition.petitions.map(function (item) {
                    return m("div", {class: "row", style: "margin-top: 25px"},[
                        m("div",{class: "card col-6 offset-3"}, [
                                m("div", {class: "row"}, [
                                    m("div", {class: "col-3"}, [
                                        m("img", {src: "https://www.assemblee-nationale.fr/dyn/assets/images/deposer-une-petition.png", width: "170"}, "Image petition")
                                    ]),
                                    m("div", {class: "col-9"}, [
                                        m("h5", {class: "text-justify"}, item.properties.titre),
                                        m("p", {class: "text-justify"}, [
                                            item.properties.description,
                                            m(m.route.Link, {class: "nav-link", onclick: function (e) {
                                                Petition.petitionID = item.key.name
                                                Petition.getPetitions(Petition.nextPage).then(function(e) {
                                                    m.route.set("/petition/"+ item.key.name)
                                                })
                                            }}, "Plus de details")
                                        ]),
                                        m("p", {class: "text-right text-success"},item.properties.nombreSignature + "  signatures pour un objectif de 2 0000")
                                        
                                    ])
                                ])
                        ]),
                      
                ])
                }))
              
                
                 
            }
        }
        var detailPetition = {
            oninit: function(e) {
                Petition.getPetition(Petition.petitionID)
                global.signe = false,
                global.ajout = false
                global.myPetition = false
                if (Petition.petition.proprietaire == User.email) {
                    global.myPetition = true
                }
            }, 
            view: function () {
                      return m("div",{class: "row", style: "margin-top: 10px"}, [
                      m("div", {class: "col-10 offset-1"}, [
                              m("h4", {class: "text-center"},  Petition.petition.titre),
                                m("div", {class: "row"}, [
                            m("div", {class: "col-5"}, [
                                m("img", {src: "https://www.assemblee-nationale.fr/dyn/assets/images/deposer-une-petition.png"}, "Image petition"),
                                m("h6", {class: "text-center"}, Petition.petition.theme)
                            ]),
                            m("div", {class: "col-7"}, [
                                m("p",{class: "text-justify"}, Petition.petition.description),
                               m("h5", {class: "text-justify"}, "Lancé par: " + Petition.petition.nomProprietaire + "le " + Petition.petition.created_at),
                               m("h6", {class: "text-justify text-success"}, Petition.petition.nombreSignature +" personnes ont signé cette petition. Objectif à atteindre 286 signatures"),
                               m("button", {class: "btn btn-primary",style: global.myPetition ? "display: none" : "", onclick: function(e) {
                                    Petition.addSignature(Petition.petitionID)
                               }}, "Signer la petition"),
                               m("br"),
                               m("br"),
                               m("h6", {class: "text-info text-justify", style: global.signe ? "" : "display: none"}, "Vous avez déja signer cette petition !"),
                               m("h6", {class: "text-success text-justify", style: global.ajout ? "" : "display: none"}, "Pitition signée avec succès !")
                            ])
                        ])
                        ]),
                      
                    ]) 
                
            }
        }
        /* Definition des pages  */
        var createPetionPage = {
            oninit: global.active = "createPetition",
            view : function () {
                return m("div", {class: "container"}, [
                           m(navBar),
                            m("div", {class: "row"}, [
                                m("div", {class: "col-6 offset-3"}, [
                                    m("div",{style: global.login ? "" : "display: none"}, [
                                         m(createPetitionForm)
                                    ]),
                                    m("div",  {style: global.login ? "display: none" : ""}, [
                                         m(connexionBtn)
                                    ])
                                
                                ])
                           ])
                    ])
            }
        }
        var homePage =  {
            oninit: global.active = "home",
            view : function () {
                return m("div", {class: "container"}, [
                           m(navBar),
                           m("h5",{class: "text-center"}, "Liste des petitions"),
                           m(listeDesPetitions),
                           m("div", {class: "row"}, [
                               m("div", {class: "offset-6"}, [
                                   m("br"),
                                   m("ul", {class: "pagination"}, [
                                       m("li", {class: "page-item"}, [
                                            m(m.route.Link, {href: "/petitions?next="+ Petition.previous[Petition.pageActuel-1],style: Petition.pageActuel == 1 ? "display: none" : "", class: "page-link", onclick: function(e) {
                                                        if(Petition.pageActuel > 0) {
                                                            Petition.pageActuel --
                                                        }
                                                        Petition.petitions = [{properties:{description: "", theme: "", titre: "", nomProprietaire: "", nombreSignature: 0, created_at: "" }, key: {name: ""}}],
                                                         Petition.getPetitions(Petition.previous[Petition.pageActuel-1])
                                                            console.log("PAGE ACTUELLE: " +Petition.pageActuel);
                                                }}, "Precedent"),
                                            ]),
                                            m("li", {class: "page-item"}, [
                                                    m(m.route.Link, {href: "/petitions?next="+ Petition.nextPage,style: global.finList  ? "display: none" : "", class: "page-link", onclick: function(e) {
                                                                    Petition.pageActuel ++
                                                                    Petition.petitions = [{properties:{description: "", theme: "", titre: "", nomProprietaire: "", nombreSignature: 0, created_at: "" }, key: {name: ""}}],
                                                                     Petition.getPetitions(Petition.nextPage)
                                                                    console.log("PAGE ACTUELLE: " +Petition.pageActuel);
                                                        }}, "Suivant")
                                            ])
                                         ])
                               ])
                           ])
                          
                          
                    ])
            }
        }
        var exist = false
        var top100Page =  {
            oninit: function(e) {
                    exist = false
                    if(Petition.petitions.length > 0) {
                       exist = true
                    }
            },
            view : function () {
                return m("div", {class: "container"}, [
                           m(navBar),
                           m("h5",{class: "text-center"}, "Les 100 petitions les plus signées"),
                           m(top100),   
                    ])
            }
        }
        var mesPetitionsSigneesPage =  {
            oninit: global.active = "mesPetitions",
            view : function () {
                return m("div", {class: "container"}, [
                           m(navBar),
                           m("h5",{class: "text-center"}, "Liste des petitions"),
                           m(mesPetitionsSignees),
                           m("div", {class: "row"}, [
                               m("div", {class: "offset-6"}, [
                                   m("br"),
                                   m("ul", {class: "pagination"}, [
                                       m("li", {class: "page-item"}, [
                                            m(m.route.Link, {href: "mesPetition", class: "page-link", onclick: function(e) {
                                                        if(Petition.pageActuel > 0) {
                                                            Petition.pageActuel --
                                                        }
                                                        Petition.getMesPetitions(Petition.previous[Petition.pageActuel-1], User.userID)
                                                            console.log("PAGE ACTUELLE: " +Petition.pageActuel);
                                                }}, "Precedent"),
                                            ]),
                                            m("li", {class: "page-item"}, [
                                                    m(m.route.Link, {href: "/mesPetitions", class: "page-link", onclick: function(e) {
                                                                    Petition.pageActuel ++
                                                                     Petition.getPetitions(Petition.nextPage, User.userID)
                                                                    
                                                        }}, "Suivant")
                                            ])
                                         ])
                               ])
                           ])
                          
                          
                    ])
            }
        }
        var detailPetitionPage = {
             view : function () {
                return m("div", {class: "container"}, [
                           m(navBar),
                           m(detailPetition)
                    ])
            }
        }
        var loginPage = {
             view : function () {
                return m("div", {class: "container"}, [
                           m("div", {class: "row"}, [
                               m("div", {class: "col-6 offset-3"}, [
                                    m("div", {style: "margin-top: 100px"}, [
                                        m("h4", "TyniPet  Petition en ligne")
                                    ]),
                                     m(connexionBtn)
                               ])
                           ])
                           
                    ])
            }
        }

        m.route(document.body, "/", {
                "/petitions": { onmatch: function() {
                        if(!global.login ) {
                            m.route.set("/login")
                        }else {
                            global.active = "home"
                          return  homePage
                        }
                     } 
                 },
                "/": loginPage,
                "/create_petition": {onmatch: function(e) {
                        if(!global.login) {
                            m.route.set("/login")
                        }else {
                            global.active = "createPetition"
                           return createPetionPage
                        }
                     } 
                 },
                "/petition/:petitionID": {onmatch: function(e) {
                        if(!global.login) {
                            m.route.set("/login")
                        }else {
                           return detailPetitionPage
                        }
                     } 
                 } ,
                "/mesPetitions": {onmatch: function(e) {
                        if(!global.login) {
                            m.route.set("/login")
                        }else {
                            global.active = "mesPetitions"
                            return mesPetitionsSigneesPage
                        }
                     } 
                 },
                 "/top100": {onmatch: function(e) {
                        if(!global.login) {
                            m.route.set("/login")
                        }else {
                            global.active = "top100"
                            return top100Page
                        }
                     } 
                 } 
        })
    </script>
</body>
</html>